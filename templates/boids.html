<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Главная страница</title>
  <link rel="stylesheet" href="../static/css/styles.css">
  <style>
    .card canvas {
      transition: opacity 0.3s ease;
    }
    
    .card:hover canvas {
      opacity: 1;
    }
    
    .card canvas:not(:hover) {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Карточка 1 - Boids -->
    <div class="card">
      <canvas id="previewBoids" onclick="openModal('./boids.html')"></canvas>
      <div class="desc" onclick="openModal('./descriptions/boids.html')">Boids Simulation</div>
    </div>

    <!-- Карточка 2 - ACO -->
    <div class="card">
      <canvas id="previewAnts" onclick="openModal('./aco.html')"></canvas>
      <div class="desc" onclick="openModal('./descriptions/aco.html')">Ant Colony Optimization</div>
    </div>

    <!-- Карточка 3 - SDS -->
    <div class="card">
      <canvas id="previewSDS" onclick="openModal('./sds.html')"></canvas>
      <div class="desc" onclick="openModal('./descriptions/sds.html')">Stochastic Diffusion Search</div>
    </div>

    <!-- Карточка 4 - Vicsek -->
    <div class="card">
      <canvas id="previewVicsek" onclick="openModal('./vicsek.html')"></canvas>
      <div class="desc" onclick="openModal('./descriptions/vicsek.html')">Vicsek</div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <button class="close-btn" onclick="closeModal()">✕</button>
      <iframe id="modalFrame" src=""></iframe>
    </div>
  </div>

  <script>
    function openModal(page) {
      const overlay = document.getElementById("overlay");
      const frame = document.getElementById("modalFrame");

      overlay.classList.add("active");

      frame.onload = () => {
        const w = frame.contentWindow;
        if (!w) return;

        // Для ants.html (если есть глобальная функция)
        if (page.includes("ants.html") && typeof w.newGraph === "function") {
          w.newGraph();
        }
      };

      frame.src = page;
    }

    function closeModal() {
      document.getElementById("modalFrame").src = "";
      document.getElementById("overlay").classList.remove("active");
    }
  </script>

  <script type="module">
    import { initBoids } from "../static/js/boids.js";
    import { initAnts } from "../static/js/aco.js";
    import { initSDS } from "../static/js/sds.js";
    import { initVicsek } from "../static/js/vicsek.js";

    // Ждем загрузки DOM
    document.addEventListener('DOMContentLoaded', () => {
      // Превью для Boids
      const previewCanvas = document.getElementById("previewBoids");
      let boidsInstance = null;
      let isBoidsAnimating = false;

      if (previewCanvas && previewCanvas.getContext) {
        boidsInstance = initBoids(previewCanvas, { 
          boidCount: 20, 
          boidSize: 3, 
          separationWeight: 3, 
          separationDist: 70, 
          maxSpeed: 6, 
          fov: 360,
          isPreview: true,
          startPaused: true
        });

        requestAnimationFrame(() => {
          if (boidsInstance && boidsInstance.drawStaticFrame) {
            boidsInstance.drawStaticFrame();
          }
        });

        previewCanvas.addEventListener('mouseenter', () => {
          if (boidsInstance && !isBoidsAnimating) {
            isBoidsAnimating = true;
            boidsInstance.startAnimation();
          }
        });

        previewCanvas.addEventListener('mouseleave', () => {
          if (boidsInstance && isBoidsAnimating) {
            setTimeout(() => {
              if (boidsInstance) {
                boidsInstance.pauseAnimation();
                isBoidsAnimating = false;
              }
            }, 1000);
          }
        });
      }

      // Превью для ACO
      const previewAnts = document.getElementById("previewAnts");
      let antsInstance = null;
      let isAntsAnimating = false;

      if (previewAnts && previewAnts.getContext) {
        antsInstance = initAnts(previewAnts, {
          nodeCount: 8,
          alpha: 1.0,
          beta: 2.0,
          rho: 0.3,
          Q: 1.0,
          colonySize: 5,
          maxIterations: 999,
          speed: 300,
          seed: 43,
          isPreview: true
        });

        requestAnimationFrame(() => {
          if (antsInstance && antsInstance.drawStaticFrame) {
            antsInstance.drawStaticFrame();
          }
        });

        previewAnts.addEventListener('mouseenter', () => {
          if (antsInstance && !isAntsAnimating) {
            isAntsAnimating = true;
            antsInstance.start();
          }
        });

        previewAnts.addEventListener('mouseleave', () => {
          if (antsInstance && isAntsAnimating) {
            setTimeout(() => {
              if (antsInstance) {
                antsInstance.pause();
                isAntsAnimating = false;
              }
            }, 2000);
          }
        });
      }

      // Превью для SDS
      const previewSDS = document.getElementById("previewSDS");
      let sdsInstance = null;
      let isSDSAnimating = false;

      if (previewSDS && previewSDS.getContext) {
        sdsInstance = initSDS(previewSDS, {
          N: 100,
          func: 'twopeaks',
          sigma: 0.08,
          restartProb: 0.6,
          showHeatmap: false,
          showTraj: false,
          showBest: true,
          stepsPerFrame: 2,
          isPreview: true,
          startPaused: true
        });

        requestAnimationFrame(() => {
          if (sdsInstance && sdsInstance.drawStaticFrame) {
            sdsInstance.drawStaticFrame();
          }
        });

        previewSDS.addEventListener('mouseenter', () => {
          if (sdsInstance && !isSDSAnimating) {
            isSDSAnimating = true;
            sdsInstance.startAnimation();
          }
        });

        previewSDS.addEventListener('mouseleave', () => {
          if (sdsInstance && isSDSAnimating) {
            setTimeout(() => {
              if (sdsInstance) {
                sdsInstance.pauseAnimation();
                isSDSAnimating = false;
              }
            }, 1500);
          }
        });
      }

      // Превью для Vicsek
        const previewVicsek = document.getElementById("previewVicsek");
        let vicsekInstance = null;
        let isVicsekAnimating = false;

        if (previewVicsek && previewVicsek.getContext) {
          vicsekInstance = initVicsek(previewVicsek, {
            particleCount: 50,
            interactionRadius: 25,
            noiseAmplitude: 0.3,
            speed: 1.5,
            timeStep: 1.0,
            vizTrails: 30,
            showTrails: false,
            isPreview: true,
            startPaused: true
          });

          requestAnimationFrame(() => {
            if (vicsekInstance && vicsekInstance.drawStaticFrame) {
              vicsekInstance.drawStaticFrame();
            }
          });

          previewVicsek.addEventListener('mouseenter', () => {
            if (vicsekInstance && !isVicsekAnimating) {
              isVicsekAnimating = true;
              vicsekInstance.startAnimation();
            }
          });

          previewVicsek.addEventListener('mouseleave', () => {
            if (vicsekInstance && isVicsekAnimating) {
              setTimeout(() => {
                if (vicsekInstance) {
                  vicsekInstance.pauseAnimation();
                  isVicsekAnimating = false;
                }
              }, 1000);
            }
          });
        }
    });
  </script>
</body>
</html>
